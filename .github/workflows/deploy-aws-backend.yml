name: Deploy AWS Backend + Vercel Frontend

on:
  push:
    branches:
      - main
      - feat/aws-server
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch para deploy"
        required: true
        default: "feat/aws-server"

concurrency:
  group: deploy-cloud-monitoring-${{ github.ref_name || github.event.inputs.branch || 'manual' }}
  cancel-in-progress: true

jobs:
  deploy_backend_aws:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve branch
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "branch=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate AWS secrets
        env:
          AWS_EC2_HOST: ${{ secrets.AWS_EC2_HOST }}
          AWS_EC2_USER: ${{ secrets.AWS_EC2_USER }}
          AWS_EC2_SSH_KEY: ${{ secrets.AWS_EC2_SSH_KEY }}
        run: |
          set -euo pipefail
          for name in AWS_EC2_HOST AWS_EC2_USER AWS_EC2_SSH_KEY; do
            if [ -z "${!name:-}" ]; then
              echo "::error::Secret obrigatorio ausente: ${name}"
              exit 1
            fi
          done

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ secrets.AWS_EC2_PORT || '22' }}
          script_stop: true
          script: |
            set -euo pipefail
            APP_DIR="${{ secrets.AWS_EC2_APP_DIR }}"
            REPO_URL="${{ secrets.AWS_REPO_URL }}"
            BRANCH="${{ steps.vars.outputs.branch }}"

            if [ -z "${APP_DIR}" ]; then
              APP_DIR="$HOME/cloud-monitoring"
            fi
            if [ -z "${REPO_URL}" ]; then
              REPO_URL="https://github.com/Monitoramento-de-Conectividade/cloud-monitoring.git"
            fi

            if [ ! -d "${APP_DIR}/.git" ]; then
              mkdir -p "${APP_DIR}"
              git clone "${REPO_URL}" "${APP_DIR}"
            fi

            cd "${APP_DIR}"
            git fetch origin
            if git show-ref --verify --quiet "refs/heads/${BRANCH}"; then
              git checkout "${BRANCH}"
            else
              git checkout -b "${BRANCH}" "origin/${BRANCH}"
            fi
            git pull --ff-only origin "${BRANCH}"

            chmod +x scripts/ec2-deploy-backend.sh
            APP_DIR="${APP_DIR}" BRANCH="${BRANCH}" REPO_URL="${REPO_URL}" ./scripts/ec2-deploy-backend.sh

  deploy_frontend_vercel:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Vercel deploy hook secret
        env:
          VERCEL_FRONTEND_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_FRONTEND_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${VERCEL_FRONTEND_DEPLOY_HOOK_URL:-}" ]; then
            echo "::error::Secret obrigatorio ausente: VERCEL_FRONTEND_DEPLOY_HOOK_URL"
            exit 1
          fi

      - name: Trigger Vercel deploy
        env:
          VERCEL_FRONTEND_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_FRONTEND_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          response="$(curl -fsS -X POST "${VERCEL_FRONTEND_DEPLOY_HOOK_URL}")"
          echo "Vercel deploy disparado."
          echo "${response}"
